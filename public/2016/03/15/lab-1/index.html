<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
  <title>Lab 1</title>
  <link href="https://kroger-workshop.cfapps.io/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="https://kroger-workshop.cfapps.io/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://kroger-workshop.cfapps.io/images/default.png);}
  
  </style>

</head>
<body>
  <ul id="slide-out" class="side-nav">
    <li><a href="https://kroger-workshop.cfapps.io"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://kroger-workshop.cfapps.io/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://kroger-workshop.cfapps.io/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
  </ul>
  <div id="index-banner" class="parallax-container">
  <a data-activates="slide-out" class="btn-floating button-collapse" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>

    <div class="section no-pad-bot">
      <div class="container">
        <div class="row center">
          
          
            <a href="http://www.kroger.com/"><img src="https://kroger-workshop.cfapps.io/images/kroger.png" style="height:100px"></a>
          
          
        </div>
        
        <h1 class="header center teal-text text-lighten-2">Cloud Foundry Workshop at Kroger</h1>
        <div class="row center">
          <h5 class="header col s12 light">Pivotal Cloud Foundry</h5>
        </div>
        <div class="row center">

        
        
        
          <a href="https://twitter.com/pivotal"><img src="https://kroger-workshop.cfapps.io/images/twitter-dreamstale71.png"></a>
        
        
        
          <a href="https://kroger-workshop.cfapps.io/index.xml"><img src="https://kroger-workshop.cfapps.io/images/feed-dreamstale27.png"></a>
        </div>
      </div>
    </div>
    <div class="parallax">
    
      <img src="https://kroger-workshop.cfapps.io/images/default.png">
    
    </div>
  </div>



<div class="container">
  <div class="section">

    <div class="row">
      <div class="col s12">
        <div class="card-panel">
          <h4>Lab 1</h4>
          <p>
          
            
              <a href="https://kroger-workshop.cfapps.io/categories/lab/">lab</a>
            
           
          </p>
          <p>

<h2 id="pivotal-cloud-foundry-with-spring:8bd1bf82bb668bb452ca3d0d6b4e19bc">Pivotal Cloud Foundry with Spring</h2>

<h3 id="goals:8bd1bf82bb668bb452ca3d0d6b4e19bc">Goals</h3>

<p>To deploy and configure a microservice and UI, leverage the platform for monitoring &amp; management of the microservice, and do a blue green deployment with zero downtime.</p>

<h2 id="prerequisites:8bd1bf82bb668bb452ca3d0d6b4e19bc">Prerequisites</h2>

<ol>
<li><p>Java SDK 1.7+</p></li>

<li><p>Git from <a href="https://mac.github.com/">github.com</a></p></li>

<li><p>Cloud Foundry CLI for <a href="https://github.com/cloudfoundry/cli/releases">Mac</a> or <a href="http://docs.cloudfoundry.org/devguide/installcf/install-go-cli.html#windows">Windows</a></p></li>

<li><p>Curl from <a href="http://curl.haxx.se/">curl</a></p></li>

<li><p>Use the Kroger internal instance of Pivotal Cloud Foundry, follow instructions <a href="http://cloud.kroger.com">cloud.kroger.com</a> and click &lsquo;Try Cloud Foundry&rsquo;</p></li>

<li><p>OR Pivotal Web Services Account.  Create a free trial account here <a href="http://run.pivotal.io/">Pivotal Web Services</a></p></li>
</ol>

<h2 id="pre-work:8bd1bf82bb668bb452ca3d0d6b4e19bc">Pre-work</h2>

<ol>
<li>Fork and Clone <a href="https://github.com/Pivotal-Field-Engineering/pcf-workspace-devops/">PCF Workspace</a></li>
<li>Review the <a href="https://github.com/Pivotal-Field-Engineering/pcf-workspace-devops/tree/master">cities</a> application.</li>
</ol>

<h2 id="steps:8bd1bf82bb668bb452ca3d0d6b4e19bc">Steps</h2>

<p>In this workshop we are going to follow these steps to deploy apps on Cloud foundry and manage the lifecycle of the application.</p>

<p><img src="/images/devops-cf.png" alt="DevOps on CF" /></p>

<p><strong>NOTE</strong></p>

<blockquote>
<p>The instructions in this document are for Mac/Linux based CLI/Shell. If you are using Windows, you may need to adjust your slashes.</p>
</blockquote>

<h2 id="building-apps:8bd1bf82bb668bb452ca3d0d6b4e19bc">Building apps</h2>

<p>By this point, you should have cloned (or forked, or downloaded) the <a href="https://github.com/Pivotal-Field-Engineering/pcf-workspace-devops/">workspace repo</a>.  Now you will build the project and deploy it to Cloud Foundry.</p>

<p>For Linux/Mac:</p>

<pre><code class="language-bash">
cd pcf-workspace-devops/cities
./gradlew clean build

</code></pre>

<p>Windows:</p>

<pre><code class="language-bash">cd pcf-workspace-devops\cities
gradlew.bat clean build
</code></pre>

<hr />

<h1 id="part-1-introduction-to-cf-push-an-app:8bd1bf82bb668bb452ca3d0d6b4e19bc">PART 1: Introduction to CF, Push an App.</h1>

<h3 id="login-to-the-cloud-platform:8bd1bf82bb668bb452ca3d0d6b4e19bc">Login to the Cloud Platform</h3>

<p>Use <code>cf help</code> and/or <code>cf &lt;command&gt; --help</code> for details on each of the commands below.</p>

<ol>
<li>Review the docs: <a href="http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/deploy-app.html">http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/deploy-app.html</a></li>

<li><p>Login to the Pivotal Cloud Foundry.
Using the Kroger HDC instance of Cloud Foundry (everyone will use the same credentials, username and password is kroger):</p>

<pre><code class="language-bash">$ cf login -a api.cfhdc.kroger.com --skip-ssl-validation
</code></pre>

<p>If you would prefer to use Pivotal Web Services:</p>

<pre><code class="language-bash">$ cf login -a api.run.pivotal.io
</code></pre></li>

<li><p>Verify you are logged in with your own userid (<em>not admin</em>) and targeted to your PCF instance:</p>

<pre><code class="language-bash">$ cf target
</code></pre>

<blockquote>
<p>the switch <code>--skip-ssl-validation</code> is used in HDC because of self signed certificates</p>
</blockquote></li>
</ol>

<h3 id="create-a-space:8bd1bf82bb668bb452ca3d0d6b4e19bc">Create a Space</h3>

<p>This will allow you to have your own environment.</p>

<pre><code class="language-bash">$ cf create-space &lt;first-initial&gt;&lt;lastname&gt;
$ cf target -o KrogerHDC -s &lt;first-initial&gt;&lt;lastname&gt;
</code></pre>

<blockquote>
<p>This can also be done from the web ui at: <a href="http://console.cfhdc.kroger.com">console.cfhdc.kroger.com</a></p>
</blockquote>

<h3 id="push-the-app:8bd1bf82bb668bb452ca3d0d6b4e19bc">Push the app</h3>

<ol>
<li><p>Push the cities-hello, put your initials in the app name so we don&rsquo;t get conflicts</p>

<pre><code class="language-bash">$ cd cities-hello
$ cf push &lt;first-initial&gt;&lt;last-initial&gt;-cities-hello
// This will give an output which is similar to this
requested state: started
instances: 1/1
usage: 512M x 1 instances
urls: cities-hello-lactiferous-unanswerableness.cfapps.io
last uploaded: Mon Jun 15 14:53:10 UTC 2015
stack: cflinuxfs2
</code></pre></li>

<li><p>Open the app url
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</p>

<ul>
<li>When you push the apps, it will give the url route to the app.
<img src="/images/welcome.png" alt="Welcome to PCF Workshop" /></li>
</ul></li>

<li><h1 id="if-you-haven-t-already-it-is-a-good-time-to-walk-through-the-appsmanager-console-cfhdc-kroger-com-http-console-cfhdc-kroger-com:8bd1bf82bb668bb452ca3d0d6b4e19bc">If you haven&rsquo;t already it is a good time to walk through the AppsManager: <a href="http://console.cfhdc.kroger.com">console.cfhdc.kroger.com</a></h1>

<p>When you push the apps, it will give the url route to the app. <br></p>

<p><img src="/images/welcome.png" alt="Welcome to PCF Workshop" style="width: 600px;"/></p></li>

<li><p>Walk through the App Console and the Ops Manager
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 81a6939a4f87cf4073c0a92e17e83b6d7dd8f6f0</p></li>
</ol>

<h2 id="recap-part-1:8bd1bf82bb668bb452ca3d0d6b4e19bc">Recap: Part 1</h2>

<blockquote>
<p>Cloud Foundry Haiku </br>
  Here is my source code </br>
  Run it on the cloud for me </br>
  I do not care how</br></p>
</blockquote>

<h2 id="discussion-part-1:8bd1bf82bb668bb452ca3d0d6b4e19bc">Discussion: Part 1</h2>

<ul>
<li>How do you push an app to the cloud today?</li>
<li>How does the cloud platform understand which runtime to use to run the app?</li>
</ul>

<hr />

<h2 id="part-2-push-bind-monitor-scale:8bd1bf82bb668bb452ca3d0d6b4e19bc">PART 2: Push/Bind/Monitor/Scale</h2>

<p>The cities-service app requires a database service to store and fetch cities info.</p>

<h2 id="create-a-database-from-marketplace:8bd1bf82bb668bb452ca3d0d6b4e19bc">Create a Database from Marketplace</h2>

<ol>
<li><p>Review the docs on Services:</p>

<p><a href="http://docs.pivotal.io/pivotalcf/devguide/services/adding-a-service.html">Adding a Service</a> <br>
<a href="http://docs.pivotal.io/pivotalcf/devguide/services/managing-services.html">Managing Services</a></p></li>

<li><p>If you are using the Kroger instance areate a mysql service, name it as <code>&lt;YOUR INITIALS&gt;-cities-db</code></p>

<p>You can create the service from the <code>cli</code> or launch the App Manager <a href="http://console.cfhdc.kroger.com">console.cfhdc.kroger.com</a> and login.</p>

<p>Navigate to the marketplace and see the available services. Here you will create the service using the CLI.</p>

<pre><code class="language-bash">$ cf marketplace // check if mysql service is available
$ cf create-service p-mysql 100mb-dev &lt;first-initial&gt;&lt;last-initial&gt;-cities-db
</code></pre></li>

<li><p>Launch the DB console via the <code>Manage</code> link in the App Manager.  Note the database is empty.</p></li>
</ol>

<h2 id="push-the-app-1:8bd1bf82bb668bb452ca3d0d6b4e19bc">Push the App</h2>

<ol>
<li><p>Do a cf push on cities-service. Notice that the push will fail. In the next step you can learn why.</p>

<pre><code class="language-bash">$ cf push &lt;first-initial&gt;&lt;last-initial&gt;-cities-service -i 1 -m 512M -p build/libs/cities-service-0.0.1-SNAPSHOT.jar
</code></pre></li>

<li><p>Check the logs to learn more about why the application is not starting</p>

<pre><code class="language-bash">$ cf logs &lt;first-initial&gt;&lt;last-initial&gt;-cities-service --recent
</code></pre></li>
</ol>

<h2 id="manually-binding-the-service-instance:8bd1bf82bb668bb452ca3d0d6b4e19bc">Manually Binding the Service Instance</h2>

<ol>
<li>Review the docs on <a href="http://docs.pivotal.io/pivotalcf/devguide/services/bind-service.html">Binding a Service Instance</a></li>

<li><p>Bind the mysql instance <code>&lt;YOUR INITIALS&gt;-cities-db</code> to your app cities-service
You can bind from the App Manager or from the <code>cli</code></p>

<pre><code class="language-bash">$ cf bind-service &lt;first-initial&gt;&lt;last-initial&gt;-cities-service &lt;first-initial&gt;&lt;last-initial&gt;-cities-db
</code></pre></li>

<li><p>Restage your cities-service application to inject the new database.</p>

<pre><code class="language-bash">$ cf restage &lt;first-initial&gt;&lt;last-initial&gt;-cities-service
</code></pre>

<p>Notice that the application is now running.</p></li>

<li><p>Check the Env variables to see if the service is bound.
You can do it from App Manager or from the <code>cli</code></p>

<pre><code class="language-bash">$ cf env &lt;first-initial&gt;&lt;last-initial&gt;-cities-service
</code></pre></li>

<li><p>Check the MySQL database to see that it now contains data using MySQL Workbench or a similar tool.</p></li>
</ol>

<p><strong>NOTE</strong></p>

<blockquote>
<p>This app is an Spring Cloud app which uses Spring Cloud Configuration to bind to a database service provided by the cloud platform.
For more information refer to link:Spring-Cloud.adoc[this document] on Spring Cloud configuration.</p>
</blockquote>

<p><br></p>

<h2 id="binding-services-via-the-manifest:8bd1bf82bb668bb452ca3d0d6b4e19bc">Binding Services via the Manifest</h2>

<p>Next, let&rsquo;s push the cities-service app with a manifest to help automate deployment.</p>

<ol>
<li>Review the documentation: <a href="http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/manifest.html">http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/manifest.html</a></li>

<li><p>Edit the application manifest  <code>manifest.service</code> in your <code>cities-service</code></p>

<pre><code class="language-bash">$ nano manifest.service
</code></pre></li>

<li><p>Set the name of the app, the amount of memory, the number of instances, and the path to the .jar file.
<em>Be sure to name your application &lsquo;<first-initial><last-initial>-cities-service&rsquo; and use this as the host value.</em></p></li>

<li><p>Add the services binding <code>&lt;YOUR INITIALS&gt;-cities-db</code> to your deployment manifest for cities-service .</p></li>

<li><p>Now, manually unbind the service and re-push your app using the manifest.</p>

<pre><code class="language-bash">$ cf unbind-service &lt;first-initial&gt;&lt;last-initial&gt;-cities-service &lt;first-initial&gt;&lt;last-initial&gt;-cities-db
</code></pre></li>

<li><p>Test your manifest by re-pushing your app with no parameters:</p>

<pre><code class="language-bash">$ cf push -f manifest.service
</code></pre>

<p>Notice that using a manifest, you have moved the command line parameters (number of instances, memory, etc) into the manifest.</p></li>

<li><p>Verify you can access your application via a curl request:</p>

<pre><code class="language-bash">$ curl -i http://&lt;first-initial&gt;&lt;last-initial&gt;-cities-service.cfapps.io
</code></pre>

<p>We must be able to access your application at https://<first-initial><last-initial>-cities-service.cfapps.io for the next steps to work properly.</p></li>
</ol>

<p><strong>NOTE</strong></p>

<blockquote>
<p>The default manifest file for an app is <code>manifest.yml</code> and it if is present, it is automatically picked without specifying the manifest file option.
In this exercise we have used a different naming convention.</p>
</blockquote>

<p><br></p>

<h2 id="health-logging-events-via-the-cli:8bd1bf82bb668bb452ca3d0d6b4e19bc">Health, logging &amp; events via the CLI</h2>

<p>Learning about how your application is performing is critical to help you diagnose and troubleshoot potential issues. Cloud Foundry gives you options for viewing the logs.</p>

<p>To tail the logs of your application perform this command:</p>

<pre><code class="language-bash">  $ cf logs &lt;first-initial&gt;&lt;last-initial&gt;-cities-service
</code></pre>

<p>Notice that nothing is showing because there isn&rsquo;t any activity. Use the following curl command to see the application working:</p>

<pre><code class="language-bash">  $ curl -i http://&lt;first-initial&gt;&lt;last-initial&gt;-cities-service.cfapps.io/cities/
</code></pre>

<p>For other ways of viewing logs check out the documentation here: <a href="http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/streaming-logs.html#view">Streaming Logs</a></p>

<p>To view recent events, including application crashes, and error codes, you can see them from the App Manager or from the cli.</p>

<pre><code class="language-bash">  $ cf events &lt;first-initial&gt;&lt;last-initial&gt;-cities-service
</code></pre>

<p>To view the health of the application you can see from the App Manager or from the cli:</p>

<pre><code class="language-bash">  $ cf app &lt;first-initial&gt;&lt;last-initial&gt;-cities-service
</code></pre>

<p>You will get detailed output of the health</p>

<pre><code class="language-bash">  Showing health and status for app cities-service in org  / space development as...
  OK

  requested state: started
  instances: 1/1
  usage: 512M x 1 instances
  urls: cities-service.cfapps.io
  last uploaded: Wed May 27 15:53:32 UTC 2015
  stack: cflinuxfs2

       state     since                    cpu    memory           disk           details
  #0   running   2015-05-27 12:17:55 PM   0.1%   434.5M of 512M   145.4M of 1G
</code></pre>

<p><br></p>

<h2 id="environment-variables:8bd1bf82bb668bb452ca3d0d6b4e19bc">Environment variables</h2>

<p>View the environment variable and explanation of <a href="http://docs.cloudfoundry.org/devguide/deploy-apps/environment-variable.html#view-env">VCAP Env</a></p>

<pre><code class="language-bash">  $ cf env &lt;first-initial&gt;&lt;last-initial&gt;-cities-service
</code></pre>

<p>You will get the output similar to this on your terminal</p>

<pre><code class="language-bash">  Getting env variables for app rj-cities-service in org Central / space development as rajesh.jain@pivotal.io...
  OK

  System-Provided:
  {
   &quot;VCAP_SERVICES&quot;: {
    &quot;cleardb&quot;: [
     {
      &quot;credentials&quot;: {
       &quot;hostname&quot;: &quot;xxxx&quot;,
       &quot;jdbcUrl&quot;: &quot;xxxx&quot;,
       &quot;name&quot;: &quot;xxxx&quot;,
       &quot;password&quot;: &quot;xxxx&quot;,
       &quot;port&quot;: &quot;3306&quot;,
       &quot;uri&quot;: &quot;mysql://xxxx?reconnect=true&quot;,
       &quot;username&quot;: &quot;xxxx&quot;
      },
      &quot;label&quot;: &quot;cleardb&quot;,
      &quot;name&quot;: &quot;rj-cities-db&quot;,
      &quot;plan&quot;: &quot;spark&quot;,
      &quot;tags&quot;: [
       &quot;Data Stores&quot;,
       &quot;Cloud Databases&quot;,
       &quot;Developer Tools&quot;,
       &quot;Data Store&quot;,
       &quot;mysql&quot;,
       &quot;relational&quot;
      ]
     }
    ]
   }
  }

  {
   &quot;VCAP_APPLICATION&quot;: {
    &quot;application_name&quot;: &quot;rj-cities-service&quot;,
    &quot;application_uris&quot;: [
     &quot;rj-cities-service.cfapps.io&quot;
    ],
    &quot;application_version&quot;: &quot;c3c35527-424f-4dbc-a4ea-115e1250cc5d&quot;,
    &quot;limits&quot;: {
     &quot;disk&quot;: 1024,
     &quot;fds&quot;: 16384,
     &quot;mem&quot;: 512
    },
    &quot;name&quot;: &quot;rj-cities-service&quot;,
    &quot;space_id&quot;: &quot;56e1d8ef-e87f-4b1c-930b-e7f46c00e483&quot;,
    &quot;space_name&quot;: &quot;development&quot;,
    &quot;uris&quot;: [
     &quot;rj-cities-service.cfapps.io&quot;
    ],
    &quot;users&quot;: null,
    &quot;version&quot;: &quot;c3c35527-424f-4dbc-a4ea-115e1250cc5d&quot;
   }
  }

  User-Provided:
  SPRING_PROFILES_ACTIVE: cloud

  No running env variables have been set

  No staging env variables have been set
</code></pre>

<h2 id="scaling-apps:8bd1bf82bb668bb452ca3d0d6b4e19bc">Scaling apps</h2>

<p>Applications can be scaled via the command line or the console. When we talk about scale, there are two different types of scale: Vertical and Horizontal. Read <a href="http://docs.cloudfoundry.org/devguide/deploy-apps/cf-scale.html">Scaling Apps</a> doc on more details on scaling applications.</p>

<p>When you vertically scale your application, you are increasing the amount of memory made available to your application. You would vertically scale your application while profiling your app, do performance tuning and to find the best memory settings before you deploy it in production.
Scaling your application horizontally means that you are adding application instances to increase your application throughput and performance under load.</p>

<p>Let&rsquo;s vertically scale the application to 1 GB of RAM.</p>

<pre><code class="language-bash">  $ cf scale &lt;first-initial&gt;&lt;last-initial&gt;-cities-service -m 1G
</code></pre>

<p>Now scale your application down to 512 MB.</p>

<p>Next, let&rsquo;s scale up your application to 2 instances</p>

<pre><code class="language-bash">  $ cf scale &lt;first-initial&gt;&lt;last-initial&gt;-cities-service -i 2
</code></pre>

<p>To check the status of your applications you can check from the command line to see how many instances your app is running and their current state</p>

<pre><code class="language-bash">  $ cf app &lt;first-initial&gt;&lt;last-initial&gt;-cities-service
</code></pre>

<p>Once the second instance as started, scale the app back down to one instance.</p>

<p><br></p>

<h2 id="verify-the-app-from-the-console:8bd1bf82bb668bb452ca3d0d6b4e19bc">Verify the app from the Console</h2>

<p>To verify that the application is running, use the following curl commands to retrieve data from the service or use a browser to access the URL:</p>

<pre><code class="language-bash">  $ curl -i http://&lt;first-initial&gt;&lt;last-initial&gt;-cities-service.cfapps.io/cities
</code></pre>

<pre><code class="language-bash">  $ curl -i http://&lt;first-initial&gt;&lt;last-initial&gt;-cities-service.cfapps.io/cities/162
</code></pre>

<pre><code class="language-bash">  $ curl -i http://&lt;first-initial&gt;&lt;last-initial&gt;-cities-service.cfapps.io/cities?size=5
</code></pre>

<p><br></p>

<h2 id="discussion-part-2:8bd1bf82bb668bb452ca3d0d6b4e19bc">Discussion: Part 2</h2>

<p>In this part of the workshop we created a database service from the marketplace, pushed an app, bound it to the database service, monitored the health of the app and scaled the app.</p>

<ol>
<li>How does the app get the database info today vs. VCAP_SERVICES? <br></li>
<li>How do you horizontally scale your applications?</li>
</ol>

<p><br>
<hr></p>

<h2 id="part-3-deploying-upstream-app-and-bind-to-backend-services:8bd1bf82bb668bb452ca3d0d6b4e19bc">PART 3: Deploying Upstream App and Bind to backend services</h2>

<p>The <code>cities</code> directory also includes a <code>cities-ui</code> application which uses the <code>cities-client</code> to consume from the <code>cities-service</code>.</p>

<p>The <code>cities-client</code> demonstrates using the <a href="http://cloud.spring.io/spring-cloud-connectors">Spring Cloud Connector</a> project to consume from a microservice.  This is a common pattern for Cloud Native apps.  For more details on building 12 Factor Apps for the Cloud (Cloud Foundry) refer to <a href="http://12factor.net/">12 Factor</a> website.</p>

<p>The goal of this exercise is to use what you have learned to deploy the <code>cities-ui</code> application.</p>

<h2 id="build-the-cities-ui-and-cities-client-app:8bd1bf82bb668bb452ca3d0d6b4e19bc">Build the Cities UI and Cities Client App</h2>

<p>The cities-ui and cities-client can be both built at once by running <code>./gradlew assemble</code> in the parent <code>cities</code> directory. Run this command now.</p>

<h2 id="create-a-user-provided-service-instance:8bd1bf82bb668bb452ca3d0d6b4e19bc">Create a User Provided Service Instance.</h2>

<p>In this section we will create a backend microservice end point for cities-service.</p>

<ol>
<li>Review the documentation on link:<a href="http://docs.pivotal.io/pivotalcf/devguide/services/user-provided.html[User">http://docs.pivotal.io/pivotalcf/devguide/services/user-provided.html[User</a> Provided Service Instances]</li>

<li><p>Look for the details by running <code>cf cups --help</code>.</p></li>

<li><p>You will need to specify two parameters when you create the service instance: <code>uri</code> and <code>tag</code> (see: CitiesWebServiceInfoCreator.java in the cities-client project). <br>
The <code>uri</code> should point to your deployed microservice <br>
The <code>tag</code> is a property specified in the CitiesWebServiceInfoCreator.  Tags have a special meaning in CF: <br></p>

<p><em>Tags</em> provide a flexible mechanism to expose a classification, attribute, or base technology of a service, enabling equivalent services to be swapped out without changes to dependent logic in applications, buildpacks, or other services. <br>
 Eg. mysql, relational, redis, key-value, caching, messaging, amqp.<br />
 <br>
 Tags also allow application configurations to be independent of a service instance name._</p></li>

<li><p>Refer to the CitiesWebServiceInfoCreator class for the necessary tag value.</p></li>
</ol>

<pre><code class="language-bash">  // Use the interactive prompt to create user defined service
  // It will prompt you for the parameters

  $ cf create-user-provided-service &lt;first-initial&gt;&lt;last-initial&gt;-cities-ws -p &quot;uri,tag&quot;

  uri&gt;   http://&lt;first-initial&gt;&lt;last-initial&gt;-cities-service.cfapps.io/
  tag&gt;   cities

  Creating user provided service....
</code></pre>

<p><br></p>

<h2 id="deploy-cities-ui-project:8bd1bf82bb668bb452ca3d0d6b4e19bc">Deploy cities-ui project</h2>

<p>A <code>manifest.yml</code> is included in the cities-ui app.  Edit this manifest with your initials and add the service binding to your cities-service</p>

<pre><code class="language-bash">  ---
  applications:
  - name: &lt;YOUR INITIALS&gt;-cities-ui
    memory: 512M
    instances: 1
    path: build/libs/cities-ui.jar
    services: [ &lt;YOUR INITIALS&gt;-cities-ws ]
    env:
      SPRING_PROFILES_ACTIVE: cloud
</code></pre>

<p>Push the <code>cities-ui</code> without specifying the manifest.yml. It will by default pick the manifest.yml file and deploy the app.</p>

<pre><code class="language-bash">  $ cf push
</code></pre>

<p>Note the URL once the application has been successfully pushed.</p>

<h2 id="verify-the-backend-service-is-bound-to-cities-ui:8bd1bf82bb668bb452ca3d0d6b4e19bc">Verify the backend service is bound to cities-ui</h2>

<pre><code class="language-bash">----
$ cf env &lt;first-initial&gt;&lt;last-initial&gt;-cities-ui

System-Provided:
{
 &quot;VCAP_SERVICES&quot;: {
  &quot;user-provided&quot;: [
   {
    &quot;credentials&quot;: {
     &quot;tag&quot;: &quot;cities&quot;,
     &quot;uri&quot;: &quot;http://rj-cities-service.cfapps.io/&quot;
    },
    &quot;label&quot;: &quot;user-provided&quot;,
    &quot;name&quot;: &quot;cities-ws&quot;,
    &quot;syslog_drain_url&quot;: &quot;&quot;,
    &quot;tags&quot;: []
   }
  ]
 }
}

{
 &quot;VCAP_APPLICATION&quot;: {
  &quot;application_name&quot;: &quot;rj-cities-ui&quot;,
  &quot;application_uris&quot;: [
   &quot;rj-cities-ui.cfapps.io&quot;
  ],
  &quot;application_version&quot;: &quot;dceb111b-3a68-45ad-83fd-3b8b836ebbe7&quot;,
  &quot;limits&quot;: {
   &quot;disk&quot;: 1024,
   &quot;fds&quot;: 16384,
   &quot;mem&quot;: 512
  },
  &quot;name&quot;: &quot;rj-cities-ui&quot;,
  &quot;space_id&quot;: &quot;56e1d8ef-e87f-4b1c-930b-e7f46c00e483&quot;,
  &quot;space_name&quot;: &quot;development&quot;,
  &quot;uris&quot;: [
   &quot;rj-cities-ui.cfapps.io&quot;
  ],
  &quot;users&quot;: null,
  &quot;version&quot;: &quot;dceb111b-3a68-45ad-83fd-3b8b836ebbe7&quot;
 }
}

User-Provided:
SPRING_PROFILES_ACTIVE: cloud
</code></pre>

<h2 id="access-the-cities-ui-to-verify-it-is-connected-to-your-microservice:8bd1bf82bb668bb452ca3d0d6b4e19bc">Access the cities-ui to verify it is connected to your microservice.</h2>

<p>Open the App Manager (Console) and navigate to your apps. You will see the cities-ui app, with a link to launch the cities-ui application. Alternatively you can open up your browser and navigate to the URL listed from a successful cf push command.</p>

<p><img src="/images/cities-ui.png" alt="Cities UI" style="width: 600px;"/></p>

<h2 id="discussion-part-3:8bd1bf82bb668bb452ca3d0d6b4e19bc">Discussion: Part 3</h2>

<p>In this part of the workshop we created a cities-ui app which is loosely bound and independently developed from the backend service. We bound that app to the cities-service microservice.</p>

<ol>
<li>Discussion on loose coupling of your services from your app and 12 Factor App design principles.</li>
</ol>

<p><br>
<hr></p>

<h2 id="part-4-deploy-version-2-of-the-app:8bd1bf82bb668bb452ca3d0d6b4e19bc">PART 4: Deploy Version 2 of the App</h2>

<p>In this section we are going to do a green-blue deployment using a shell script. The same can be done by executing the commands one at a time.
<br></p>

<h2 id="delete-the-unversioned-app-and-the-route:8bd1bf82bb668bb452ca3d0d6b4e19bc">Delete the unversioned app and the route</h2>

<pre><code class="language-bash">  cf delete &lt;first-initial&gt;&lt;last-initial&gt;-cities-ui
  cf delete-route cfapps.io -n &lt;first-initial&gt;&lt;last-initial&gt;-cities-ui
</code></pre>

<p><br></p>

<h2 id="push-version-2-and-delete-the-old-route-using-the-script:8bd1bf82bb668bb452ca3d0d6b4e19bc">Push Version 2 and Delete the Old Route using the script</h2>

<p>We are going to deploy the next version of the <code>cities-ui</code> app. The deployment typically is automated using a CD pipeline built with Jenkins or any CD automation tool, but in this workshop we will walk through a simple version number change in the deployment manifest.</p>

<ol>
<li><p>Edit the <code>manifest.blue-green</code> with the following variables</p>

<pre><code class="language-bash">VERSION: CITIES_APP_1_0
</code></pre></li>

<li><p>Edit and source the <code>env</code> file from the cities-ui folder with the following variables</p>

<pre><code class="language-bash">export CF_SYSTEM_DOMAIN=     //CF_SYSTEM_DOMAIN will look similar to run.pivotal.io
export CF_APPS_DOMAIN=       //CF_APPS_DOMAIN will look similar to cfapps.io
export CF_USER=              //CF_USER is the user account to sign into Pivotal Cloud Foundry, which is usually your email address.
export CF_ORG=               //CF_ORG is the name of the Organization within Pivotal Cloud Foundry where you want to deploy your applications.
export CF_SPACE=             //CF_SPACE is the name of the Space within the above Organization where you want your application deployed.
export CF_APP=&lt;first-initial&gt;&lt;last-initial&gt;-cities-ui
export CF_JAR=build/libs/cities-ui.jar
export CF_MANIFEST=manifest.blue-green
export BUILD_NUMBER=1001
</code></pre>

<p><strong>Note</strong></p>

<blockquote>
<p>Be sure to change the CF_APP name to match your application and add the BUILD_NUMBER to the env file. Add the Version number &gt;in the manifest.blue-green</p>
</blockquote></li>

<li><p>First deploy the blue v1 of the app.</p>

<pre><code class="language-bash">// Push the new version of the app, with the version number and route
$cf push &quot;$CF_APP-$BUILD_NUMBER&quot; -n &quot;$CF_APP-$BUILD_NUMBER&quot; -d $CF_APPS_DOMAIN -p $CF_JAR -f $CF_MANIFEST
</code></pre></li>

<li><p>Next, increment the BUILD_NUMBER in the env file and source it. Change the VERSION number in the manifest.blue-green</p>

<pre><code class="language-bash">....
export BUILD_NUMBER=2001
$nano manifest.yml
....
VERSION: CITIES_APP_2_0
</code></pre></li>

<li><p>Deploy the green v2 and delete the blue v1 of the app.</p>

<pre><code class="language-bash">// Push the new version of the app, with the version number and route
$cf push &quot;$CF_APP-$BUILD_NUMBER&quot; -n &quot;$CF_APP-$BUILD_NUMBER&quot; -d $CF_APPS_DOMAIN -p $CF_JAR -f $CF_MANIFEST


// Map the route to point to the new app
$cf map-route &quot;$CF_APP-${BUILD_NUMBER}&quot; $CF_APPS_DOMAIN -n $CF_APP


// Get the deployed version of the app
$export DEPLOYED_VERSION=`cf apps | grep $CF_APP- | cut -d&quot; &quot; -f1`


// Un-map an existing routes and delete the app / routes


$cf unmap-route &quot;$DEPLOYED_VERSION&quot; $CF_APPS_DOMAIN -n $CF_APP
$cf delete &quot;$DEPLOYED_VERSION&quot; -f
$cf delete-route $CF_APPS_DOMAIN -n &quot;$DEPLOYED_VERSION&quot; -f
</code></pre></li>

<li><p>Alternatively, use the bash script <code>blue-green.sh</code> in the cities-ui directory, deploy the green v2 and delete the blue v1 of the app. <br>
If you are using the script make sure you increment the BUILD_NUMBER in the env file and change the VERSION number in the manifest.blue-green.</p>

<pre><code class="language-bash">$ cat blue-green.sh


source env
cf login -a https://api.$CF_SYSTEM_DOMAIN -u $CF_USER -o $CF_ORG -s $CF_SPACE --skip-ssl-validation


DEPLOYED_VERSION_CMD=$(CF_COLOR=false cf apps | grep $CF_APP- | cut -d&quot; &quot; -f1)
DEPLOYED_VERSION=&quot;$DEPLOYED_VERSION_CMD&quot;
ROUTE_VERSION=$(echo &quot;${BUILD_NUMBER}&quot; | cut -d&quot;.&quot; -f1-3 | tr '.' '-')
echo &quot;Deployed Version: $DEPLOYED_VERSION&quot;
echo &quot;Route Version: $ROUTE_VERSION&quot;

# push a new version and map the route
cf push &quot;$CF_APP-$BUILD_NUMBER&quot; -n &quot;$CF_APP-$ROUTE_VERSION&quot; -d $CF_APPS_DOMAIN -p $CF_JAR -f $CF_MANIFEST
cf map-route &quot;$CF_APP-${BUILD_NUMBER}&quot; $CF_APPS_DOMAIN -n $CF_APP


if [ ! -z &quot;$DEPLOYED_VERSION&quot; -a &quot;$DEPLOYED_VERSION&quot; != &quot; &quot; -a &quot;$DEPLOYED_VERSION&quot; != &quot;$CF_APP-${BUILD_NUMBER}&quot; ]; then
  echo &quot;Performing zero-downtime cutover to $BUILD_NUMBER&quot;
  echo &quot;$DEPLOYED_VERSION&quot; | while read line
  do
    if [ ! -z &quot;$line&quot; -a &quot;$line&quot; != &quot; &quot; -a &quot;$line&quot; != &quot;$CF_APP-${BUILD_NUMBER}&quot; ]; then
      echo &quot;Scaling down, unmapping and removing $line&quot;
      # Unmap the route and delete
      cf unmap-route &quot;$line&quot; $CF_APPS_DOMAIN -n $CF_APP
      cf delete &quot;$line&quot; -f
      cf delete-route $CF_APPS_DOMAIN -n &quot;$line&quot; -f
    else
      echo &quot;Skipping $line&quot;
    fi
  done
fi
</code></pre>

<p><br></p>

<h2 id="verify-the-app-zero-downtime:8bd1bf82bb668bb452ca3d0d6b4e19bc">Verify the app, zero downtime</h2>

<pre><code class="language-bash">$cf apps | grep -i cities-ui
rj-cities-ui-1001                       started           1/1         512M     1G     rj-cities-ui.cfapps.io, rj-cities-ui-5001.cfapps.io


</code></pre>

<pre><code class="language-bash">$cf routes | grep -i cities-ui


development   rj-cities-ui                                           cfapps.io   rj-cities-ui-2001
development   rj-cities-ui-1001                                      cfapps.io   rj-cities-ui-2001


</code></pre>

<pre><code class="language-bash">

$ curl -i http://&lt;first-initial&gt;&lt;last-initial&gt;-cities-ui.cfapps.io/cities/version


HTTP/1.1 200 OK
Content-Type: text/plain;charset=ISO-8859-1
Date: Thu, 21 May 2015 02:22:29 GMT
Server: Apache-Coyote/1.1
X-Application-Context: rj-cities-ui-1001:cloud:0
X-Cf-Requestid: d9fa0481-5cb4-47cd-6335-35adf575a0b6
Content-Length: 4
Connection: keep-alive


CITIES_APP_2_0


</code></pre>

<p><br></p>

<h2 id="repeat-the-process:8bd1bf82bb668bb452ca3d0d6b4e19bc">Repeat the Process</h2>

<p>Change the version (in the manifest) and build numbers (in the env file) and run the script to do blue-green deployment. Check the output using curl.</p></li>
</ol>

<p><br></p>

<h2 id="process-of-blue-green-deployment:8bd1bf82bb668bb452ca3d0d6b4e19bc">Process of Blue Green Deployment</h2>

<p>Review the CF Document for blue green deployment link:<a href="http://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html[Using">http://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html[Using</a> Blue-Green Deployment to Reduce Downtime and Risk]</p>

<p>In summary Blue-green deployment is a release technique that reduces downtime and risk by running two identical production environments called Blue and Green.</p>

<p><img src="/images/blue-green-process.png" alt="Blue Green Deployment Process" style="width: 600px;"/></p>

<h2 id="newsworthy-automated-blue-green-with-cf-plugin:8bd1bf82bb668bb452ca3d0d6b4e19bc">Newsworthy: Automated Blue Green with cf plugin</h2>

<p>Cloud Foundry plugin <a href="https://github.com/concourse/autopilot">Autopilot</a> does blue green deployment, albeit it takes a different approach to other zero-downtime plugins. It doesn&rsquo;t perform any complex route re-mappings instead it leans on the manifest feature of the Cloud Foundry CLI. The method also has the advantage of treating a manifest as the source of truth and will converge the state of the system towards that. This makes the plugin ideal for continuous delivery environments.</p>

<pre><code class="language-bash">
  $ mkdir $HOME/go
  $ export GOPATH=$HOME/go
  $ export PATH=$PATH:$GOPATH/bin

  $ go get github.com/concourse/autopilot
  $ cf install-plugin $GOPATH/bin/autopilot
  $ cd cities-services
  // Increment the Build
  $ cf zero-downtime-push cities-services \
      -f manifest.blue-green \
      -p build/libs//cities-service-0.0.1-SNAPSHOT.jar

</code></pre>

<h2 id="discussion-part-4:8bd1bf82bb668bb452ca3d0d6b4e19bc">Discussion: Part 4</h2>

<p>In this part of the workshop did deployment using a blue green script without any downtime.
This script / methodology can be used in your CD pipeline to build and deploy Cloud Native Apps with zero downtime.</p>

<ol>
<li>Discussion on how do you do Continous Deployment and Delivery with zero downtime today.</li>
</ol>

<h2 id="recap:8bd1bf82bb668bb452ca3d0d6b4e19bc">Recap</h2>

<p>In this workshop we saw how to build, deploy, bind, scale, monitor apps on Cloud foundry and manage the lifecycle of the application</p>

<p><img src="/images/devops-cf.png" alt="DevOps on CF" /></p>

<h2 id="q-a:8bd1bf82bb668bb452ca3d0d6b4e19bc">Q/A</h2>

<h2 id="feedback:8bd1bf82bb668bb452ca3d0d6b4e19bc">Feedback</h2>

<p>Please provide your feedback using this form <a href="https://docs.google.com/a/pivotal.io/forms/d/1qWlLtTuoULomw9DAW0tuhn7YVWXwVILaMTNKfXkcq0s/viewform?usp=send_form">Feedback Form</a></p>
</p>
          <p>15 Mar 2016
            
              
                <a href="https://kroger-workshop.cfapps.io/tags/spring/">#spring</a>
              
                <a href="https://kroger-workshop.cfapps.io/tags/microservices/">#microservices</a>
              
                <a href="https://kroger-workshop.cfapps.io/tags/cloudfoundry/">#cloudfoundry</a>
              
            
          </p>
          
            <div id="disqus_thread"></div>
<script type="text/javascript">
     
    var disqus_shortname = 'Rajesh Jain';
    
     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
          
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://kroger-workshop.cfapps.io/2016/04/11/lab-3/"><i class="mdi-navigation-arrow-back"></i></a>
      
      </div>
      <div class="col s6 m10 center">&nbsp</div>
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://kroger-workshop.cfapps.io/2016/03/15/lab-2/"><i class="mdi-navigation-arrow-forward"></i></a>
      
      </div>
    </div>

  </div>
</div>

  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
      © 2015 Copyright Text
      <div class="right">Design <a class="grey-text text-lighten-4" href="http://pdevty.github.io/blog/">pdevty</a></div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://kroger-workshop.cfapps.io/js/materialize.min.js"></script>
  <script src="https://kroger-workshop.cfapps.io/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-75133856-1', 'auto');
    ga('send', 'pageview');
  </script>
  

  </body>
</html>

